# 🌟 环境变量管理器

一个跨平台的智能环境变量管理工具，支持根据不同配置快速切换API密钥、服务端点等环境变量。专为开发者和AI应用场景设计，支持多种AI服务商配置一键切换。

## ✨ 特性

- 🖥️ **全平台支持**：Windows (CMD/PowerShell)、Linux、macOS
- 🔧 **多配置管理**：预置主流AI服务商配置，支持自定义扩展
- ⚡ **一键切换**：快速在不同API配置间切换
- 🔒 **配置验证**：检查关键配置是否已正确设置
- 📁 **脚本生成**：自动生成各平台的配置脚本
- 🔐 **配置加密**：使用 AES-256 加密保护敏感信息
- 📝 **.env 支持**：导入/导出 .env 格式文件
- 💾 **永久设置**：直接写入系统环境变量
- 📦 **可执行打包**：打包为独立可执行文件，无需安装 Python
- 🐍 **Python驱动**：纯Python实现，无需额外依赖（加密功能除外）

## 📦 预置配置

| 配置名称 | 服务商 | 典型用途 |
|---------|--------|---------|
| `qwen3-coder-plus` | 阿里云DashScope | Qwen系列代码模型 |
| `gpt` | OpenAI | GPT-4/GPT-3.5系列 |
| `claude` | Anthropic | Claude系列模型 |
| `deepseek` | DeepSeek | DeepSeek系列模型 |

## 🚀 快速开始

### 1. 安装准备

确保系统已安装 Python 3.8+，然后克隆或下载项目文件：

```bash
# 克隆项目（如果使用Git）
git clone <repository-url>
cd env-manager

# 或直接下载文件：
# - env-manager.py
# - config.json
# - env-manager.sh (Linux/macOS)
# - env-manager.bat (Windows)
# - env-manager.ps1 (Windows PowerShell)
```

### 2. 可选依赖

如需使用加密功能，请安装 cryptography：

```bash
pip install cryptography
```

如需在 Windows 上永久设置环境变量，请安装 pywin32：

```bash
pip install pywin32
```

### 3. 配置设置

首次使用时，复制配置模板：

```bash
# 从模板创建配置文件
cp config.json.example config.json

# 或使用 --init 命令初始化
python env-manager.py --init
```

然后编辑 `config.json` 文件，将API密钥占位符替换为您的实际密钥：

```json
{
  "gpt": {
    "OPENAI_API_KEY": "sk-your-actual-key-here",  // ← 替换这里
    "OPENAI_BASE_URL": "https://api.openai.com/v1",
    "MODEL": "gpt-4"
  }
}
```

> **注意**：
> - `config.json` 已被 `.gitignore` 忽略，不会提交到仓库
> - 配置文件中的 `YOUR_*` 占位符必须替换为实际值才能正常使用
> - 敏感信息建议使用 `--encrypt` 加密存储

## 📖 使用方法

### 基本命令

```bash
# 查看所有可用配置
python env-manager.py --list

# 查看特定配置详情
python env-manager.py gpt --print

# 验证配置是否完整
python env-manager.py qwen3-coder-plus --validate
```

### 配置导出（当前会话）

**Linux/macOS (Bash/Zsh):**
```bash
# 方法1：直接导出到当前shell
source <(python env-manager.py gpt --export)

# 方法2：生成脚本文件再加载
python env-manager.py gpt --save
source env_gpt.sh
```

**Linux/macOS (Fish Shell):**
```fish
# Fish shell需要指定shell类型
python env-manager.py gpt --export --shell fish | source
```

**Windows (CMD):**
```batch
:: 使用批处理文件
env-manager.bat gpt

:: 或直接使用Python（推荐在管理员权限下运行）
python env-manager.py gpt --export --shell cmd
```

**Windows (PowerShell):**
```powershell
# 使用PowerShell脚本
.\env-manager.ps1 gpt

# 或直接使用Python
python env-manager.py gpt --export --shell powershell
```

### 🔐 配置加密

加密您的敏感配置信息，防止密钥泄露。

```bash
# 加密配置文件
python env-manager.py --encrypt

# 解密配置文件
python env-manager.py --decrypt

# 编辑加密的配置文件（临时解密后重新加密）
python env-manager.py --edit-encrypted
```

**加密文件格式：**

加密后的配置会保存为 `config.enc`，包含以下信息：
- 版本号
- 加密算法（AES-256-GCM）
- Base64 编码的加密数据

> **安全提示**：请务必保管好加密密码，密码丢失后无法恢复配置！

### 💾 永久设置环境变量

将配置直接写入系统环境变量，重启后依然生效。

**Windows:**
```batch
REM 用户范围设置
python env-manager.py gpt --permanent

REM 系统范围设置（需要管理员权限）
python env-manager.py gpt --permanent --scope system
```

**Linux/macOS:**
```bash
# 用户范围设置（写入 ~/.bashrc, ~/.zshrc 等）
python env-manager.py gpt --permanent

# 系统范围设置（需要 sudo 权限，写入 /etc/environment）
sudo python env-manager.py gpt --permanent --scope system
```

**设置范围说明：**

| 范围 | 说明 | 权限要求 |
|------|------|---------|
| `user` | 当前用户环境变量 | 普通用户权限 |
| `system` | 全局系统环境变量 | Windows: 管理员<br>Linux/macOS: sudo |

**Windows 永久设置说明：**
- 用户变量写入 `HKEY_CURRENT_USER\Environment`
- 系统变量写入 `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\Environment`
- 需要安装 `pywin32`

**Linux/macOS 永久设置说明：**
- 自动检测当前 shell 类型
- Bash/Zsh: 写入 `~/.bashrc` 或 `~/.zshrc`
- Fish: 写入 `~/.config/fish/config.fish`
- 自动清理旧的配置块

### 📝 .env 文件支持

导入和导出 `.env` 格式文件，兼容 `python-dotenv` 等工具。

**导出为 .env 文件：**
```bash
# 导出配置到 .env.gpt 文件
python env-manager.py gpt --to-dotenv

# 导出文件默认保存到 ~/.config/env-manager/
```

**从 .env 文件导入：**
```bash
# 从现有 .env 文件导入为新配置
python env-manager.py --from-dotenv .env myconfig

# 覆盖已存在的配置
python env-manager.py --from-dotenv .env myconfig --overwrite
```

**.env 文件格式示例：**
```bash
# Environment configuration for: gpt
# Generated by env-manager

OPENAI_API_KEY="sk-xxxxxxxxx"
OPENAI_BASE_URL="https://api.openai.com/v1"
MODEL="gpt-4"
```

**使用 .env 文件：**

方法1 - 直接加载：
```bash
source .env.gpt
```

方法2 - 使用 python-dotenv：
```python
from dotenv import load_dotenv
load_dotenv('.env.gpt')
```

## 🔧 配置说明

### 配置文件结构

`config.json` 采用JSON格式，每个配置项是一个完整的配置：

```json
{
  "配置名称": {
    "环境变量1": "值1",
    "环境变量2": "值2"
  }
}
```

### 预置环境变量说明

| 环境变量 | 说明 | 示例值 |
|---------|------|--------|
| `OPENAI_API_KEY` | OpenAI API密钥 | `sk-...` |
| `OPENAI_BASE_URL` | OpenAI API端点 | `https://api.openai.com/v1` |
| `ANTHROPIC_API_KEY` | Anthropic API密钥 | `sk-ant-...` |
| `ANTHROPIC_BASE_URL` | Anthropic API端点 | `https://api.anthropic.com` |
| `MODEL` | 默认模型名称 | `gpt-4`, `claude-3-opus` |
| `API_TIMEOUT` | API请求超时时间 | `30` |

### 添加自定义配置

1. 在 `config.json` 中添加新配置项：

```json
{
  "my-config": {
    "OPENAI_API_KEY": "your-key",
    "OPENAI_BASE_URL": "https://api.openai.com/v1",
    "MODEL": "gpt-3.5-turbo",
    "CUSTOM_VAR": "custom_value"
  }
}
```

2. 使用新配置：
```bash
python env-manager.py my-config --export
```

或从 .env 文件导入：
```bash
python env-manager.py --from-dotenv .env my-config
```

## 🖥️ 平台特定说明

### Linux / macOS

**权限设置：**
```bash
chmod +x env-manager.py env-manager.sh
```

**添加到 Shell 配置**（可选）：
```bash
# 添加到 ~/.bashrc 或 ~/.zshrc
alias env='python /path/to/env-manager.py'
```

**Shell 检测：**
工具会自动检测当前使用的 shell：
- `~/.bashrc` 或 `~/.bash_profile` → Bash
- `~/.zshrc` → Zsh
- `~/.config/fish/config.fish` → Fish

### Windows

**管理员权限：** 永久设置环境变量需要管理员权限

**执行策略**（PowerShell）：
```powershell
# 如果遇到执行策略错误
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

**配置目录：**
- 用户配置：`%USERPROFILE%\.config\env-manager`
- 加密文件：`config.enc`

## 📚 API参考

### 命令行参数

| 参数 | 简写 | 说明 |
|------|------|------|
| `config` | - | 配置名称 |
| `--export` | `-e` | 导出到当前shell |
| `--print` | `-p` | 打印配置详情 |
| `--save` | `-s` | 保存为脚本文件 |
| `--list` | `-l` | 列出所有配置 |
| `--validate` | `-v` | 验证配置完整性 |
| `--set` | - | 为当前进程设置 |
| `--permanent` | `-P` | 永久设置到系统 |
| `--encrypt` | - | 加密配置文件 |
| `--decrypt` | - | 解密配置文件 |
| `--edit-encrypted` | - | 编辑加密配置文件 |
| `--to-dotenv` | - | 导出为 .env 文件 |
| `--from-dotenv` | - | 从 .env 文件导入 |
| `--overwrite` | - | 覆盖已存在的配置 |
| `--info` | - | 显示应用和配置文件信息 |
| `--init` | - | 初始化配置文件 |
| `--shell` | - | 指定shell类型 |
| `--scope` | - | 设置范围：user/system |
| `--password` | - | 加密/解密密码 |
| `--config-file` | - | 自定义配置文件 |

### Shell类型支持

| Shell类型 | 平台 | 导出格式 |
|-----------|------|----------|
| `bash` | Linux/macOS | `export VAR=value` |
| `zsh` | macOS | `export VAR=value` |
| `fish` | Linux/macOS | `set -gx VAR value` |
| `cmd` | Windows | `set VAR=value` |
| `powershell` | Windows | `$env:VAR="value"` |

## 🔄 工作流示例

### 开发环境配置

```bash
# 1. 加载开发环境配置
source <(python env-manager.py gpt --export)

# 2. 验证设置
python env-manager.py gpt --validate

# 3. 运行应用程序
python my_ai_app.py
```

### 生产环境部署

```bash
# 1. 加载生产环境配置
python env-manager.py prod --permanent

# 2. 重启服务使环境变量生效
systemctl restart my-service
```

### CI/CD 流水线配置

```yaml
# GitHub Actions 示例
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Python
        uses: actions/setup-python@v4
      - name: Load Environment
        env:
          ENCRYPTION_PASSWORD: ${{ secrets.ENCRYPTION_PASSWORD }}
        run: |
          python env-manager.py --decrypt
          python env-manager.py test --set
      - name: Run Tests
        run: python -m pytest tests/
```

### 安全配置管理

```bash
# 1. 编辑敏感配置
python env-manager.py --edit-encrypted

# 2. 加密配置文件
python env-manager.py --encrypt

# 3. 提交加密文件到版本控制
git add config.enc
git commit -m "Update encrypted config"
```

## 🐳 Docker 支持

### 在 Docker 中使用

```dockerfile
FROM python:3.9-slim

# 复制环境管理器
COPY env-manager.py /usr/local/bin/
RUN chmod +x /usr/local/bin/env-manager.py

# 安装依赖
RUN pip install cryptography pywin32; exit 0

# 设置工作目录
WORKDIR /app

# 复制配置文件
COPY config.enc /app/
COPY .env /app/

# 解密配置（密码从环境变量传入）
ENV ENCRYPTION_PASSWORD=""
CMD sh -c "echo $ENCRYPTION_PASSWORD | python env-manager.py --decrypt && python app.py"
```

### Docker Compose 集成

```yaml
version: '3.8'
services:
  app:
    build: .
    environment:
      - CONFIG_NAME=gpt
      - ENCRYPTION_PASSWORD=${ENCRYPTION_PASSWORD}
    command: >
      sh -c "echo $ENCRYPTION_PASSWORD | python env-manager.py --decrypt &&
             python env-manager.py $CONFIG_NAME --set &&
             python your_app.py"
```

## 📦 打包和分发

将 Python 脚本打包为独立可执行文件，无需安装 Python 即可运行。

### 快速打包

```bash
# 1. 安装打包依赖
pip install -r requirements.txt

# 2. 执行打包脚本
python build.py

# 3. 打包完成后，可执行文件位于 dist/ 目录
```

### 使用可执行文件

打包后的 `dist/` 目录包含：

```
dist/
├── env-manager          # Linux/macOS 可执行文件
├── env-manager.exe      # Windows 可执行文件
├── config.json          # 配置文件
├── QUICKSTART.md        # 快速开始指南
└── env-manager.sh       # 启动脚本（Linux/macOS）
```

将整个 `dist/` 目录复制到目标机器，直接运行可执行文件即可：

**Windows:**
```cmd
REM 直接运行
env-manager.exe --list

REM 或使用启动脚本
env-manager.bat gpt --export
```

**Linux/macOS:**
```bash
# 添加执行权限
chmod +x env-manager

# 直接运行
./env-manager --list

# 或使用启动脚本
./env-manager.sh gpt --export
```

### 配置文件位置

打包后的可执行文件会自动查找配置文件，优先级如下：

1. **程序同目录**：`config.json` 与可执行文件在同一目录
2. **用户配置目录**：`~/.config/env-manager/config.json`

首次运行时，可以使用 `--init` 创建默认配置：

```bash
env-manager.exe --init
```

或使用 `--info` 查看应用和配置文件信息：

```bash
env-manager.exe --info
```

### 分发包制作

打包完成后，可以制作压缩包进行分发：

**Linux/macOS:**
```bash
cd dist
tar -czf env-manager-linux-x64.tar.gz *
```

**Windows:**
```batch
REM 使用 PowerShell 压缩
Compress-Archive -Path dist\* -DestinationPath env-manager-win64.zip
```

**macOS .app 包:**
如需制作 macOS .app 包，可以在 spec 文件中配置或使用第三方工具如 `create-dmg`。

### 平台特定打包

在不同平台上打包会生成对应平台的可执行文件：

| 打包平台 | 输出文件 | 可运行平台 |
|---------|---------|-----------|
| Windows | `env-manager.exe` | Windows |
| Linux | `env-manager` | Linux (glibc) |
| macOS | `env-manager` | macOS |

**交叉编译说明**：PyInstaller 不支持真正的交叉编译，需要在目标平台上分别打包。

### 自定义打包

编辑 `build.py` 脚本可以自定义打包选项：

- 修改 `APP_NAME` 改变输出文件名
- 添加图标文件 `icon.ico` (Windows) 或 `icon.icns` (macOS)
- 调整 `spec` 文件中的 `console` 参数（Windows GUI 模式）

**高级用户**：可以直接修改 `env-manager.spec` 文件实现更复杂的打包配置。

## 🛠️ 故障排除

### 常见问题

**Q: 导出的环境变量在关闭终端后失效**
> A: 这是正常行为，环境变量只在当前会话有效。如需永久生效，请使用 `--permanent` 选项。

**Q: Windows 永久设置环境变量失败**
> A: 确保以管理员身份运行，并已安装 `pywin32`：`pip install pywin32`

**Q: 加密功能不可用**
> A: 请安装 cryptography 库：`pip install cryptography`

**Q: 忘记了加密密码怎么办**
> A: 加密使用强加密算法，密码丢失后无法恢复。请备份重要配置或使用密码管理器。

**Q: PowerShell 脚本无法运行**
> A: 设置执行策略：`Set-ExecutionPolicy RemoteSigned -Scope CurrentUser`

**Q: 永久设置后环境变量未生效**
> A: 重启终端或应用程序。Windows 系统变量需要完全注销/重启。

**Q: .env 文件导入失败**
> A: 检查文件格式是否正确（KEY=VALUE 格式），确保不包含非法字符。

**Q: 打包后找不到配置文件**
> A: 确保配置文件 `config.json` 与可执行文件在同一目录，或放置在 `~/.config/env-manager/`。

**Q: Windows 上运行 .exe 提示缺少 DLL**
> A: 某些 Windows 系统可能需要安装 [Microsoft Visual C++ Redistributable](https://aka.ms/vs/17/release/vc_redist.x64.exe)。

**Q: macOS 提示应用已损坏**
> A: macOS Gatekeeper 可能拦截未签名的应用。在终端运行：`xattr -d com.apple.quarantine env-manager`

**Q: Linux 上提示权限不足**
> A: 添加执行权限：`chmod +x env-manager`

**Q: 打包文件体积太大**
> A: 可以在 `build.py` 中启用 UPX 压缩，或排除不需要的模块。

## 📁 文件结构

```
env-manager/
├── env-manager.py          # 主程序
├── build.py               # 打包脚本
├── requirements.txt       # 依赖列表
├── .gitignore            # Git 忽略配置
├── config.json.example    # 配置文件模板
├── config.json           # 配置文件（实际，本地使用）
├── config.enc            # 加密配置文件（可选）
├── local_config.json     # 本地覆盖配置（可选）
├── env-manager.sh        # Linux/macOS Shell 脚本
├── env-manager.bat      # Windows CMD 脚本
├── env-manager.ps1      # Windows PowerShell 脚本
├── env-manager.spec     # PyInstaller 配置（自动生成）
├── README.md            # 使用文档
├── QUICKSTART.md        # 快速开始（打包后生成）
├── build/               # 构建临时目录（忽略）
└── dist/                # 打包输出目录（忽略）
    ├── env-manager       # Linux/macOS 可执行文件
    ├── env-manager.exe   # Windows 可执行文件
    ├── config.json      # 配置文件
    └── env-manager.sh   # 启动脚本
```

> **Git 状态**：标记为 "忽略" 的文件不会被提交到版本控制库

## 🔐 安全建议

1. **不要将明文 config.json 提交到版本控制**
   - 使用 `--encrypt` 加密后提交
   - 将 `config.json` 添加到 `.gitignore`

2. **使用密码管理器**
   - 加密密码应使用密码管理器存储
   - 不要在脚本中硬编码密码

3. **定期轮换密钥**
   - 定期更新 API 密钥
   - 重新加密配置文件

4. **限制权限**
   - 配置文件权限设置为仅所有者可读：`chmod 600 config.enc`

## 🤝 贡献指南

欢迎提交 Issue 和 Pull Request！

### 开发设置

```bash
# 1. 克隆仓库
git clone <repository-url>
cd env-manager

# 2. 创建虚拟环境
python -m venv venv

# 3. 激活虚拟环境
# Linux/macOS:
source venv/bin/activate
# Windows:
venv\Scripts\activate

# 4. 安装依赖
pip install cryptography pywin32
```

## 📄 许可证

本项目采用 MIT 许可证。

## 🙏 致谢

感谢以下开源项目提供的灵感：
- [direnv](https://direnv.net/) - 环境切换工具
- [python-dotenv](https://github.com/theskumar/python-dotenv) - Python环境变量管理
- [cryptography](https://github.com/pyca/cryptography) - 加密库
- [PyInstaller](https://pyinstaller.org/) - Python 打包工具

---

**版本**: 3.0.0
